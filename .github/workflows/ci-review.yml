name: CI Review Bot

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: read
  pull-requests: write

env:
  LAMBDA_URL: ${{secrets.CI_REVIEW_LAMBDA_URL}} 
  MAX_FILES: 10

jobs:
  ai-review:
    runs-on: ubuntu-latest
    steps:
      # â”€â”€ 1. ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ â”€â”€
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # â”€â”€ 2. å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ã®å·®åˆ†ã‚’å–å¾—ã—ã¦ JSON åŒ– â”€â”€
      - name: Collect diffs
        id: diff
        env:
          GH_TOKEN: ${{secrets.GITHUB_TOKEN}}
        run: |
          # PR ã®å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’å–å¾—ï¼ˆæœ€å¤§ MAX_FILESï¼‰
          FILES_JSON=$(gh api \
            "repos/${{github.repository}}/pulls/${{github.event.pull_request.number}}/files" \
            --jq "[.[:$MAX_FILES][] | {filename: .filename, patch: (.patch // \"\")}]")

          # ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãå‡ºã—ï¼ˆã‚·ã‚§ãƒ«å¤‰æ•°ã®é•·ã•åˆ¶é™å›é¿ï¼‰
          echo "$FILES_JSON" | jq -c '{files: .}' > /tmp/payload.json

      # â”€â”€ 3. PR ã«ã€Œå‡¦ç†ä¸­â€¦ã€ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆ â”€â”€
      - name: Create placeholder comment
        id: comment
        env:
          GH_TOKEN: ${{secrets.GITHUB_TOKEN}}
        run: |
          COMMENT_ID=$(gh api \
            "repos/${{github.repository}}/issues/${{github.event.pull_request.number}}/comments" \
            -f body="â³ **AI Review Bot** â€” å‡¦ç†ä¸­â€¦" \
            --jq '.id')
          echo "comment_id=$COMMENT_ID" >> "$GITHUB_OUTPUT"

      # â”€â”€ 4. Lambda ã«å·®åˆ†ã‚’é€ä¿¡ã— NDJSON ã‚’å—ä¿¡ â”€â”€
      - name: Call Lambda & update PR comment
        env:
          GH_TOKEN: ${{secrets.GITHUB_TOKEN}}
          COMMENT_ID: ${{steps.comment.outputs.comment_id}}
        run: |
          # --- Lambda å‘¼ã³å‡ºã—ï¼ˆ--no-buffer ã§ NDJSON ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å—ä¿¡ï¼‰ ---
          EXPLAIN=""
          REVIEW=""

          curl -sS --no-buffer -X POST \
            -H "Content-Type: application/json" \
            -d @/tmp/payload.json \
            "$LAMBDA_URL" | while IFS= read -r line; do
            [ -z "$line" ] && continue
            TYPE=$(echo "$line" | jq -r '.type')
            BODY=$(echo "$line" | jq -r '.body')

            case "$TYPE" in
              status)
                # ã‚³ãƒ¡ãƒ³ãƒˆã‚’ status ã®å†…å®¹ã§æ›´æ–°
                gh api \
                  "repos/${{github.repository}}/issues/comments/$COMMENT_ID" \
                  -X PATCH \
                  -f body="â³ **AI Review Bot** â€” $BODY" \
                  --silent
                ;;
              explain)
                EXPLAIN="$BODY"
                echo "$BODY" > /tmp/explain.txt
                ;;
              review)
                REVIEW="$BODY"
                echo "$BODY" > /tmp/review.txt
                ;;
              error)
                echo "::warning::Lambda error: $BODY"
                ;;
            esac

            # explain or review ã‚’å—ã‘å–ã‚‹ãŸã³ã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°
            if [ -n "$EXPLAIN" ] || [ -n "$REVIEW" ]; then
              COMMENT_BODY=""
              if [ -n "$EXPLAIN" ]; then
                COMMENT_BODY="## ğŸ“ å¤‰æ›´æ¦‚è¦
          $EXPLAIN"
              fi
              if [ -n "$REVIEW" ]; then
                COMMENT_BODY="$COMMENT_BODY

          ## ğŸ” ãƒ¬ãƒ“ãƒ¥ãƒ¼
          $REVIEW"
              fi

              gh api \
                "repos/${{github.repository}}/issues/comments/$COMMENT_ID" \
                -X PATCH \
                -f body="$COMMENT_BODY" \
                --silent
            fi
          done

          # --- æœ€çµ‚ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆä¸¡æ–¹æƒã£ãŸã‹ç¢ºèªï¼‰ ---
          if [ ! -s /tmp/explain.txt ] && [ ! -s /tmp/review.txt ]; then
            gh api \
              "repos/${{github.repository}}/issues/comments/$COMMENT_ID" \
              -X PATCH \
              -f body="âŒ **AI Review Bot** â€” ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ" \
              --silent
            exit 1
          fi
name: CI Review Bot

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: read
  pull-requests: write

env:
  LAMBDA_URL: ${{secrets.CI_REVIEW_LAMBDA_URL}} 
  MAX_FILES: 10

jobs:
  ai-review:
    runs-on: ubuntu-latest
    steps:
      # ‚îÄ‚îÄ 1. „ÉÅ„Çß„ÉÉ„ÇØ„Ç¢„Ç¶„Éà ‚îÄ‚îÄ
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ‚îÄ‚îÄ 2. Â§âÊõ¥„Éï„Ç°„Ç§„É´„ÅÆÂ∑ÆÂàÜ„ÇíÂèñÂæó„Åó„Å¶ JSON Âåñ ‚îÄ‚îÄ
      - name: Collect diffs
        id: diff
        env:
          GH_TOKEN: ${{secrets.GITHUB_TOKEN}}
        run: |
          # PR „ÅÆÂ§âÊõ¥„Éï„Ç°„Ç§„É´‰∏ÄË¶ß„ÇíÂèñÂæóÔºàÊúÄÂ§ß MAX_FILESÔºâ
          FILES_JSON=$(gh api \
            "repos/${{github.repository}}/pulls/${{github.event.pull_request.number}}/files" \
            --jq "[.[:$MAX_FILES][] | {filename: .filename, patch: (.patch // \"\")}]")

          # „Éï„Ç°„Ç§„É´„Å´Êõ∏„ÅçÂá∫„ÅóÔºà„Ç∑„Çß„É´Â§âÊï∞„ÅÆÈï∑„ÅïÂà∂ÈôêÂõûÈÅøÔºâ
          echo "$FILES_JSON" | jq -c '{files: .}' > /tmp/payload.json

      # ‚îÄ‚îÄ 3. PR „Å´„ÄåÂá¶ÁêÜ‰∏≠‚Ä¶„Äç„Ç≥„É°„É≥„Éà„Çí‰ΩúÊàê ‚îÄ‚îÄ
      - name: Create placeholder comment
        id: comment
        env:
          GH_TOKEN: ${{secrets.GITHUB_TOKEN}}
        run: |
          COMMENT_ID=$(gh api \
            "repos/${{github.repository}}/issues/${{github.event.pull_request.number}}/comments" \
            -f body="‚è≥ **AI Review Bot** ‚Äî Âá¶ÁêÜ‰∏≠‚Ä¶" \
            --jq '.id')
          echo "comment_id=$COMMENT_ID" >> "$GITHUB_OUTPUT"

      # ‚îÄ‚îÄ 4. Lambda „Å´Â∑ÆÂàÜ„ÇíÈÄÅ‰ø°„Åó NDJSON „ÇíÂèó‰ø° ‚îÄ‚îÄ
      - name: Call Lambda & update PR comment
        env:
          GH_TOKEN: ${{secrets.GITHUB_TOKEN}}
          COMMENT_ID: ${{steps.comment.outputs.comment_id}}
        run: |
          # --- Lambda Âëº„Å≥Âá∫„ÅóÔºà--no-buffer „Åß NDJSON „Çí„É™„Ç¢„É´„Çø„Ç§„É†Âèó‰ø°Ôºâ ---
          curl -sS --no-buffer -X POST \
            -H "Content-Type: application/json" \
            -d @/tmp/payload.json \
            "$LAMBDA_URL" > /tmp/response.ndjson

          # --- NDJSON „Çí„Éë„Éº„Çπ„Åó„Å¶Â§âÊï∞„Å´Ê†ºÁ¥ç ---
          EXPLAIN=""
          REVIEW=""

          while IFS= read -r line; do
            [ -z "$line" ] && continue
            TYPE=$(echo "$line" | jq -r '.type')
            BODY=$(echo "$line" | jq -r '.body')

            case "$TYPE" in
              status)
                # „Ç≥„É°„É≥„Éà„Çí status „ÅÆÂÜÖÂÆπ„ÅßÊõ¥Êñ∞
                gh api \
                  "repos/${{github.repository}}/issues/comments/$COMMENT_ID" \
                  -X PATCH \
                  -f body="‚è≥ **AI Review Bot** ‚Äî $BODY" \
                  --silent
                ;;
              explain)
                EXPLAIN="$BODY"
                ;;
              review)
                REVIEW="$BODY"
                ;;
              error)
                echo "::warning::Lambda error: $BODY"
                ;;
            esac

            # explain or review „ÇíÂèó„ÅëÂèñ„Çã„Åü„Å≥„Å´„Ç≥„É°„É≥„Éà„ÇíÊõ¥Êñ∞
            if [ -n "$EXPLAIN" ] || [ -n "$REVIEW" ]; then
              COMMENT_BODY=""
              if [ -n "$EXPLAIN" ]; then
                COMMENT_BODY="## üìù Â§âÊõ¥Ê¶ÇË¶Å
          $EXPLAIN"
              fi
              if [ -n "$REVIEW" ]; then
                COMMENT_BODY="$COMMENT_BODY

          ## üîç „É¨„Éì„É•„Éº
          $REVIEW"
              fi

              gh api \
                "repos/${{github.repository}}/issues/comments/$COMMENT_ID" \
                -X PATCH \
                -f body="$COMMENT_BODY" \
                --silent
            fi
          done < /tmp/response.ndjson

          # --- ÊúÄÁµÇ„Ç≥„É°„É≥„ÉàÔºà‰∏°ÊñπÊèÉ„Å£„Åü„ÅãÁ¢∫Ë™çÔºâ ---
          if [ -z "$EXPLAIN" ] && [ -z "$REVIEW" ]; then
            gh api \
              "repos/${{github.repository}}/issues/comments/$COMMENT_ID" \
              -X PATCH \
              -f body="‚ùå **AI Review Bot** ‚Äî „É¨„Éì„É•„ÉºÁµêÊûú„ÇíÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü" \
              --silent
            exit 1
          fi